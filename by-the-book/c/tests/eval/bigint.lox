var base = 10;

fun zeros(n) {
    var r = [];
    for (var i = 0; i < n; i += 1) {
        r = r + [0];
    }
    return r;
}

fun iszero(a) {
    for (var i = 0; i < #a; i += 1) {
        if (a[i] == 0) {} else { return false; }
    }
    return true;
}

fun fromnum(I) {
    var a = [];
    var i = I | 0;
    if (i == 0) { return [0]; }
    while (i > 0) {
        setArray(a, #a, i % base);
        i = i / base;
    }
    return a;
}

fun normalize(v) {
    if (type(v) == "VAL_INT" or type(v) == "VAL_BOOL" or type(v) == "VAL_DOUBLE") {
        return fromnum(v);
    }
    while (#v > 1 and v[#v-1] == 0) rmArrayTop(v);
    return v;
}

fun add(a, b) {
    var carry = 0;
    var c;
    if (#a > #b) { c = zeros(#a); } else { c = zeros(#b); }
    for (var i = 0; i < #c; i += 1) {
        var total = carry;
        if (i < #a) {
            total = total + a[i];
        }
        if (i < #b) {
            total = total + b[i];
        }
        carry = (total / base)|0; // TODO
        setArray(c, i, total % base);
    }
    if (carry == 0) {
    } else {
        setArray(c, #c, carry);
    }
    return c;
}

fun eq(a, b) {
    if (#a == #b) {} else { return false; }
    for (var i = 0; i < #a; i += 1) {
        if (a[i] == b[i]) {} else { return false; }
    }
    return true;
}

fun lt(a, b) {
    if (#a == #b) {} else { return #a < #b; }
    for (var i = 0; i < #a; i += 1) {
        if (a[i] == b[i]) {} else { return #a < #b; }
    }
    return false;
}

fun le(a, b) {
    return lt(a, b) or eq(a, b);
}

fun sub(a, b) {
    a = normalize(a);
    b = normalize(b);
    if (eq(a, b)) { return fromnum(0); }
    if (lt(a, b)) { return fromnum(0); }
    var c = zeros(#a);
    var carry = 0;
    var total;
    for (var i = 0; i < #a; i += 1) {
        if (i < #b) {
            total = a[i] - b[i] + carry;
        } else {
            total = a[i] + carry;
        }
        if (total < 0) {
            total = total + base;
            carry = -1;
        } else {
            carry = 0;
        }
        setArray(c, i, total);
    }
    return normalize(c);
}

fun _mul(a, b) {
    var N = #a + #b;
    var c = zeros(N);
    for (var i = 0; i < #a; i += 1) {
        for (var j = 0; j < #b; j += 1) {
            setArray(c, i + j, c[i + j] + a[i] * b[j]);
        }
    }
    var carry = 0;
    for (var i = 0; i < N; i += 1) {
        var total = c[i] + carry;
        setArray(c, i, total % base);
        carry = (total|0) / (base|0);
    }
    return normalize(c);
}

fun halve(a) {
    var magic = 0;
    var c = zeros(#a);
    for (var i = #a - 1; i >= 0; i = i - 1) {
        var digit = (a[i] >> 1) + magic;
        magic = (a[i] & 1) * (base / 2);
        setArray(c, i, digit);
    }
    return normalize(c);
}

fun _pow(a, b, mulfunc) {
    var exponent = b;
    var v = a;
    var r = fromnum(1);
    while (!iszero(exponent)) {
        if (exponent[0] & 1 == 1) {
            r = mulfunc(r, v);
        }
        v = mulfunc(v, v);
        exponent = halve(exponent);
    }
    return normalize(r);
}

fun split(t, midpoint) {
    var lo = [];
    var hi = [];
    for (var i = 0; i < #t; i += 1) {
        var h;
        if (i <= midpoint) { h = lo; } else { h = hi; }
        setArray(h, #h, t[i]);
    }
    return [lo, hi];
}

fun mul(a, b) {
    if (#a < 3 or #b < 3) {
        return _mul(a, b);
    }

    var m2;
    if (#a >= #b) { m2 = #a; } else { m2 = #b; }
    m2 /= 2;  // TODO floor

    var a_split = split(a, m2);
    var b_split = split(b, m2);
    var l1 = a_split[0]; // TODO destructuring assignment
    var h1 = a_split[1]; // TODO destructuring assignment
    var l2 = b_split[0]; // TODO destructuring assignment
    var h2 = b_split[1]; // TODO destructuring assignment
    
    var k0 = mul(l1, l2);
    var k1 = mul(add(l1, h1), add(l2, h2));
    var k2 = mul(h1, h2);
    return add(
        _mul(k2, _pow(ibase, fromnum(m2 * 2), _mul)),
        add(
            _mul(sub(k1, add(k2, k0)), _pow(ibase, fromnum(m2), _mul)),
            k0
        )
    );
}

fun print10(t) {
    for (var i = #t - 1; i >= 0; i = i - 1) {
            prints(t[i]);
    }
    print("");
}

var ibase = fromnum(base);

print(zeros(10));
print("expect 13431513511 * 1141441414 = 15331285774155944554
");
print10(_mul(fromnum(13431513511), fromnum(1141441414)));
print10(mul(fromnum(13431513511), fromnum(1141441414)));
prints("expect 134513511 + 1141414 = ", 134513511 + 1141414, "
");
print10(add(fromnum(134513511), fromnum(1141414)));
print(fromnum(1223311));
print(fromnum(1223311));
print10(sub(_pow(fromnum(2), fromnum(255), _mul), fromnum(19)));
print10(sub(_pow(fromnum(2), fromnum(255), mul), fromnum(19)));
print('$ python3 -c "print(2**255-19)"');
print("57896044618658097711785492504343953926634992332820282019728792003956564819949");
